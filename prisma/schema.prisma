// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core User Management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  roleId    String?  // Direct role assignment for simplified RBAC
  teamId    String?  // Team assignment
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  role                Role?              @relation("UserRole", fields: [roleId], references: [id], onDelete: SetNull)
  team                Team?              @relation("TeamMembers", fields: [teamId], references: [id], onDelete: SetNull)
  userRoles           UserRole[]         // Keep existing many-to-many for complex scenarios
  userSessions        UserSession[]
  auditLogs           AuditLog[]
  assignedTickets     Ticket[]           @relation("AssignedTickets")
  createdTickets      Ticket[]           @relation("CreatedTickets")
  comments            Comment[]
  teamLeaderships     TeamLeader[]       // Teams this user leads
  ticketFollowers     TicketFollower[]
  uploadedAttachments    TicketAttachment[]
  ticketHistory          TicketHistory[]
  notifications          Notification[]
  notificationPreference NotificationPreferences?
  createdTemplates       TicketTemplate[]

  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions Json?    // Store permissions as JSON for flexibility
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  users           User[]         @relation("UserRole")
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  resource    String   // 'tickets', 'users', 'knowledge_base', etc.
  action      String   // 'read', 'write', 'delete', 'manage'
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// Team Management
model Team {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  members            User[]                   @relation("TeamMembers")
  teamLeaders        TeamLeader[]
  tickets            Ticket[]                 @relation("TeamTickets")
  knowledgeArticles  KnowledgeBaseArticle[]   @relation("TeamArticles")

  @@map("teams")
}

model TeamLeader {
  id         String   @id @default(cuid())
  userId     String
  teamId     String
  assignedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("team_leaders")
}

// Session Management
model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

// Audit Logging
model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  action       String   // Action performed (create, read, update, delete, assign_role, etc.)
  resourceType String   // Type of resource (user, team, role, etc.)
  resourceId   String?  // ID of the affected resource
  success      Boolean  @default(true) // Whether the action was successful
  details      Json?    // Additional details about the action
  ipAddress    String?
  userAgent    String?
  timestamp    DateTime @default(now())

  // Relationships
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// Customer Support System
model Customer {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?
  company   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  tickets  Ticket[]
  feedback TicketFeedback[]

  @@map("customers")
}

model Ticket {
  id          String         @id @default(cuid())
  title       String
  description String
  status      TicketStatus   @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  category    String?
  customerId  String
  assignedTo  String?
  teamId      String?
  createdBy   String
  slaDueAt    DateTime?
  resolvedAt  DateTime?
  closedAt    DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relationships
  customer       Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  assignedUser   User?              @relation("AssignedTickets", fields: [assignedTo], references: [id], onDelete: SetNull)
  creator        User               @relation("CreatedTickets", fields: [createdBy], references: [id], onDelete: Cascade)
  team           Team?              @relation("TeamTickets", fields: [teamId], references: [id], onDelete: SetNull)
  comments       Comment[]
  ticketTags     TicketTag[]
  followers      TicketFollower[]
  attachments    TicketAttachment[]
  history        TicketHistory[]
  feedback       TicketFeedback?

  @@index([teamId])
  @@index([createdBy])
  @@index([status])
  @@index([priority])
  @@index([slaDueAt])
  @@map("tickets")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  ticketId  String
  authorId  String
  isInternal Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model Tag {
  id          String   @id @default(cuid())
  name        String   @unique
  color       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relationships
  ticketTags TicketTag[]

  @@map("tags")
}

model TicketTag {
  id       String @id @default(cuid())
  ticketId String
  tagId    String

  // Relationships
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([ticketId, tagId])
  @@map("ticket_tags")
}

model TicketFollower {
  id        String   @id @default(cuid())
  ticketId  String
  userId    String
  addedBy   String?
  addedAt   DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([ticketId, userId])
  @@index([userId])
  @@index([ticketId])
  @@map("ticket_followers")
}

model TicketAttachment {
  id         String   @id @default(cuid())
  ticketId   String
  uploadedBy String
  fileName   String
  filePath   String
  fileSize   Int
  mimeType   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relationships
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  uploader User   @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@map("ticket_attachments")
}

model TicketHistory {
  id        String   @id @default(cuid())
  ticketId  String
  userId    String
  action    String
  fieldName String?
  oldValue  String?
  newValue  String?
  createdAt DateTime @default(now())

  // Relationships
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([userId])
  @@map("ticket_history")
}

model SLAPolicy {
  id                   String         @id @default(cuid())
  name                 String
  description          String?
  priority             TicketPriority
  responseTimeHours    Int
  resolutionTimeHours  Int
  isActive             Boolean        @default(true)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  @@map("sla_policies")
}

model EscalationRule {
  id             String   @id @default(cuid())
  name           String
  description    String?
  conditionType  String
  conditionValue Json
  actionType     String
  actionConfig   Json
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("escalation_rules")
}

model TicketFeedback {
  id         String   @id @default(cuid())
  ticketId   String   @unique
  customerId String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relationships
  ticket   Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("ticket_feedback")
}

// Knowledge Base
model KnowledgeBaseArticle {
  id           String               @id @default(cuid())
  title        String
  content      String
  summary      String?
  accessLevel  KnowledgeAccessLevel @default(PUBLIC)
  isPublished  Boolean              @default(false)
  authorId     String?
  teamId       String?
  category     String?
  viewCount    Int                  @default(0)
  helpfulCount Int                  @default(0)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  // Relationships
  team              Team?                 @relation("TeamArticles", fields: [teamId], references: [id], onDelete: SetNull)
  articleCategories KBArticleCategory[]

  @@index([teamId])
  @@index([category])
  @@index([accessLevel])
  @@map("knowledge_base_articles")
}

model KBCategory {
  id          String               @id @default(cuid())
  name        String
  description String?
  parentId    String?
  accessLevel KnowledgeAccessLevel @default(PUBLIC)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  // Relationships
  parent            KBCategory?         @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children          KBCategory[]        @relation("CategoryHierarchy")
  articleCategories KBArticleCategory[]

  @@map("kb_categories")
}

model KBArticleCategory {
  id         String   @id @default(cuid())
  articleId  String
  categoryId String

  // Relationships
  article  KnowledgeBaseArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)
  category KBCategory           @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([articleId, categoryId])
  @@map("kb_article_categories")
}

// Notification System
model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  ticketId  String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreferences {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  emailEnabled           Boolean  @default(true)
  inAppEnabled           Boolean  @default(true)
  notifyOnCreation       Boolean  @default(true)
  notifyOnAssignment     Boolean  @default(true)
  notifyOnStatusChange   Boolean  @default(true)
  notifyOnComment        Boolean  @default(true)
  notifyOnResolution     Boolean  @default(true)
  notifyOnSLABreach      Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

// Ticket Templates
model TicketTemplate {
  id          String         @id @default(cuid())
  name        String
  description String?
  category    String?
  title       String?
  content     String?
  priority    TicketPriority @default(MEDIUM)
  isGlobal    Boolean        @default(false) // Global templates (Admin_Manager only) vs personal templates
  createdBy   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relationships
  creator User @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([createdBy])
  @@index([category])
  @@index([isGlobal])
  @@map("ticket_templates")
}

// System Settings
model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String   @default("string") // string, number, boolean, json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("settings")
}

// Enums
enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum KnowledgeAccessLevel {
  PUBLIC
  INTERNAL
  RESTRICTED
}

enum NotificationType {
  TICKET_CREATED
  TICKET_ASSIGNED
  TICKET_STATUS_CHANGED
  TICKET_COMMENT
  TICKET_RESOLVED
  SLA_BREACH
  ESCALATION
}
